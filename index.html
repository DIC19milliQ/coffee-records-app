<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>珈琲豆記録帖</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Noto Sans JP", system-ui, -apple-system, sans-serif;
      --bg: #f7f5f2;
      --card: #ffffff;
      --text: #2f2a24;
      --muted: #6c6156;
      --accent: #7b4e2e;
      --accent-soft: #f1e4d8;
      --line: #e2d8cd;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    header {
      padding: 20px 16px 12px;
      background: var(--card);
      border-bottom: 1px solid var(--line);
    }
    header h1 {
      margin: 0 0 8px;
      font-size: 1.6rem;
    }
    .header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    button {
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #fff;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.ghost {
      background: transparent;
      color: var(--accent);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    nav {
      display: flex;
      gap: 6px;
      padding: 8px 16px;
      background: var(--card);
      border-bottom: 1px solid var(--line);
      position: sticky;
      top: 0;
      z-index: 10;
      overflow-x: auto;
    }
    nav button {
      background: var(--accent-soft);
      color: var(--text);
      border: 1px solid var(--line);
      padding: 6px 14px;
      border-radius: 999px;
      white-space: nowrap;
    }
    nav button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    main {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .tab-panel {
      display: none;
      gap: 16px;
      flex-direction: column;
    }
    .tab-panel.active {
      display: flex;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      border: 1px solid var(--line);
    }
    .card h2 {
      margin-top: 0;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .filters > input[type="text"] {
      flex: 1;
      min-width: 220px;
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    input[type="text"], input[type="number"], select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--line);
      width: 100%;
      font-size: 0.95rem;
    }
    .table-wrap {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    th.sortable {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    tr.expandable {
      cursor: pointer;
    }
    tr.expandable:hover {
      background: #faf6f2;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--accent-soft);
      color: var(--text);
    }
    .mode-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .mode-buttons button {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .mode-buttons button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    .muted {
      color: var(--muted);
    }
    .result-count {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .chart-container {
      width: 100%;
      overflow-x: auto;
    }
    canvas {
      width: 100%;
      max-width: 640px;
      height: 360px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
    }
    #map {
      width: 100%;
      overflow-x: auto;
    }
    #map svg {
      width: 100%;
      height: auto;
      min-height: 360px;
    }
    .legend {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .legend-bar {
      width: 160px;
      height: 10px;
      background: linear-gradient(90deg, #f5f3ef, #e0b98c, #c8783b, #8b3f1f);
      border-radius: 999px;
      border: 1px solid var(--line);
    }
    .pill {
      background: var(--accent-soft);
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
    }
    .map-toolbar {
      display: flex;
      gap: 8px;
      align-items: end;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .map-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 290px;
      gap: 12px;
      align-items: start;
    }
    .country-drawer {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
      position: sticky;
      top: 8px;
      min-height: 220px;
    }
    .drawer-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .drawer-metrics div {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .country-beans {
      margin: 0;
      padding-left: 18px;
      max-height: 220px;
      overflow: auto;
    }
    .suggestions {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .suggestion-item {
      width: 100%;
      text-align: left;
      border-radius: 8px;
      padding: 6px 8px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
    }
    @media (max-width: 960px) {
      .map-layout {
        grid-template-columns: 1fr;
      }
      .country-drawer {
        position: static;
      }
    }

    .analysis-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    tr.small {
      background: #fcf8f3;
    }
    tr.insufficient {
      color: var(--muted);
    }
    .quick-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .filter-group {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
    }
    .filter-group h3 {
      margin: 0 0 8px;
      font-size: 0.9rem;
    }
    .option-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .option-list label {
      font-size: 0.85rem;
    }
    .sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--card);
      border-radius: 16px 16px 0 0;
      border: 1px solid var(--line);
      border-bottom: none;
      box-shadow: 0 -8px 20px rgba(0,0,0,0.12);
      transform: translateY(105%);
      transition: transform 0.2s ease;
      z-index: 40;
      max-height: 82vh;
      display: flex;
      flex-direction: column;
    }
    .sheet.open { transform: translateY(0); }
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 30;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .sheet-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }
    .sheet-header {
      position: sticky;
      top: 0;
      background: var(--card);
      padding: 10px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1;
    }
    .sheet-content {
      padding: 12px 16px 20px;
      overflow-y: auto;
    }
    .sheet-note {
      white-space: pre-wrap;
      line-height: 1.5;
      word-break: break-word;
    }
    .sub-toggle {
      margin: 12px 0;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
      background: #fff;
    }
    .similar-list {
      margin: 6px 0 0;
      padding-left: 18px;
    }
    dialog {
      border: none;
      border-radius: 16px;
      padding: 0;
      max-width: 520px;
      width: 90%;
    }
    dialog::backdrop {
      background: rgba(0,0,0,0.3);
    }
    .dialog-body {
      padding: 20px;
    }
    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      padding: 12px 20px 20px;
      gap: 8px;
    }
    .analysis-heatmap {
      display: grid;
      gap: 6px;
      align-items: stretch;
    }

    .heatmap-table-wrap {
      overflow-x: auto;
    }
    .heatmap-table {
      width: max-content;
      min-width: 100%;
      table-layout: fixed;
      border-collapse: separate;
      border-spacing: 6px;
    }
    .heatmap-table th,
    .heatmap-table td {
      border-bottom: none;
      padding: 0;
      text-align: center;
      vertical-align: middle;
    }
    .heatmap-table thead th {
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
      padding: 4px;
    }
    .heatmap-table .heatmap-row-label {
      min-width: 180px;
      width: 180px;
      text-align: left;
      padding: 4px 8px;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
      background: transparent;
      border: none;
    }
    .heatmap-table .heatmap-col-header {
      width: 110px;
      min-width: 110px;
      max-width: 110px;
      white-space: nowrap;
    }
    .heatmap-table td.heatmap-cell {
      width: 110px;
      min-width: 110px;
      max-width: 110px;
      height: 70px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: color-mix(in srgb, #c8783b calc(var(--heat, 0.2) * 100%), #fff);
      padding: 8px;
    }
    .heatmap-cell-button {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      padding: 0;
    }
    .analysis-heatmap .heatmap-col-header,
    .analysis-heatmap .heatmap-row-label {
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4px;
    }
    .analysis-heatmap .heatmap-row-label {
      justify-content: flex-start;
      font-weight: 600;
      color: var(--text);
    }
    .analysis-heatmap .heatmap-cell {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
      min-height: 70px;
      background: color-mix(in srgb, #c8783b calc(var(--heat, 0.2) * 100%), #fff);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      color: var(--text);
    }
    .analysis-heatmap .heatmap-cell.clickable {
      cursor: pointer;
    }
    .analysis-heatmap .heatmap-cell.small {
      opacity: 0.7;
    }
    .metric-main {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.1;
    }
    .metric-sub {
      font-size: 0.78rem;
      color: var(--muted);
      align-self: flex-end;
    }
    .detail-scroll {
      max-height: 300px;
      overflow-y: auto;
    }
    .analysis-detail-panel {
      min-height: 260px;
    }
    .mapping-main {
      margin-top: 10px;
    }
    .mapping-frame {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      max-height: min(420px, 45vh);
      overflow: auto;
      background: #fff;
    }
    .bubble-legend {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--muted);
    }
    .bubble-legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .bubble-size {
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #f4ece2;
      display: inline-block;
    }
    .rating-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .heatmap-legend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--muted);
      margin: 6px 0 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
</head>

<body>
  <header>
    <h1>珈琲豆記録帖</h1>
    <div class="header-row">
      <div id="status" class="muted">読み込み中...</div>
      <div class="header-actions">
        <span class="pill">最終取得: <span id="updated-at">--</span></span>
        <button id="reload">再取得</button>
      </div>
    </div>
  </header>
  <nav>
    <button class="active" data-tab="search">図鑑</button>
    <button data-tab="ranking">味検索</button>
    <button data-tab="analysis">傾向</button>
    <button data-tab="map">地図</button>
  </nav>
  <main>
    <section id="tab-search" class="tab-panel active"><div id="mode-search"></div></section>
    <section id="tab-ranking" class="tab-panel"><div id="mode-ranking"></div></section>
    <section id="tab-analysis" class="tab-panel"><div id="mode-analysis"></div></section>
    <section id="tab-map" class="tab-panel"><div id="mode-map"></div></section>
  </main>

  <script type="module" src="./app.js"></script>
</body>
</html>
